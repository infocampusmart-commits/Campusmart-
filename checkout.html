<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Checkout</title>
<link rel="icon" href="Blue 1.png">

<style>
body{
  font-family:Arial,sans-serif;
  background:#f5f5f5;
  padding:20px;
}
.checkout-container{
  max-width:500px;
  margin:auto;
  background:#fff;
  padding:20px;
  border-radius:12px;
  box-shadow:0 4px 10px rgba(0,0,0,.1);
}
h2{text-align:center;margin-bottom:20px}
.product-summary{text-align:center;margin-bottom:20px}
.product-summary img{
  width:120px;
  border-radius:8px;
  margin-bottom:10px;
}
label{font-weight:bold;margin-top:10px;display:block}
input,select,button{
  width:100%;
  padding:10px;
  margin-top:5px;
  margin-bottom:15px;
  border-radius:8px;
  border:1px solid #ddd;
}
button{
  background:blue;
  color:#fff;
  border:none;
  cursor:pointer;
}
button:hover{background:#87CEEB}
.pay-link{
  background:#0aa84f;
}
.pay-link:hover{
  background:#0ccf65;
}
#spinner{text-align:center;display:none;margin-top:10px}
</style>
</head>

<body>

<div class="checkout-container">
<h2>Checkout</h2>

<div id="checkoutProduct" class="product-summary"></div>

<form id="checkoutForm">

<label>Full Name</label>
<input type="text" id="name" required>

<label>Email</label>
<input type="email" id="email" required>

<label>Location</label>
<select id="location" required>
<option value="">-- Select --</option>
<option value="Covenant University">Covenant University</option>
<option value="Bells University">Bells University</option>
<option value="Crawford University">Crawford University</option>
</select>

<label>Hall / Hostel</label>
<input type="text" id="hall" required>

<label>Room Number</label>
<input type="text" id="room" required>

<label>Phone</label>
<input type="tel" id="phone" required>

<!-- PAYMENT LINK -->
<label>Make Payment</label>
<a href="https://paystack.com/pay/YOUR_PAYMENT_LINK" target="_blank">
  <button type="button" class="pay-link">üí≥ Pay Now</button>
</a>

<!-- RECEIPT -->
<label>Upload Payment Receipt</label>
<input type="file" id="receipt" accept="image/*,application/pdf" required>

<button type="submit">üì¶ Submit Order</button>
</form>

<div id="spinner">Processing order...</div>
</div>

<script>
// =====================
// PRODUCT LOAD
// =====================
const product = JSON.parse(localStorage.getItem("zakuSelectedProduct"));

if(!product){
  alert("No product selected");
  window.location.href = "mart.html";
}

document.getElementById("checkoutProduct").innerHTML = `
  <img src="${product.img}">
  <h3>${product.name}</h3>
  <p><strong>‚Ç¶${product.price}</strong></p>
`;

// =====================
// CLOUDINARY CONFIG
// =====================
const CLOUD_NAME = "dgyrt3rpj";
const UPLOAD_PRESET = "campusmartstore";

// =====================
// FORM SUBMIT
// =====================
document.getElementById("checkoutForm").addEventListener("submit", async function(e){
  e.preventDefault();

  const receiptFile = document.getElementById("receipt").files[0];
  if(!receiptFile){
    alert("Please upload payment receipt");
    return;
  }

  document.getElementById("spinner").style.display = "block";

  try {
    // 1Ô∏è‚É£ Upload receipt to Cloudinary
    const cloudData = new FormData();
    cloudData.append("file", receiptFile);
    cloudData.append("upload_preset", UPLOAD_PRESET);

    const cloudRes = await fetch(
      `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/auto/upload`,
      { method: "POST", body: cloudData }
    );

    const cloudJson = await cloudRes.json();
    if(!cloudJson.secure_url){
      throw new Error("Cloudinary upload failed");
    }

    // 2Ô∏è‚É£ Send order to Google Sheets
    const orderData = {
      name: document.getElementById("name").value,
      email: document.getElementById("email").value,
      phone: document.getElementById("phone").value,
      location: document.getElementById("location").value,
      hall: document.getElementById("hall").value,
      room: document.getElementById("room").value,
      productName: product.name,
      productPrice: product.price,
      receiptUrl: cloudJson.secure_url
    };

    const sheetRes = await fetch(
      "https://script.google.com/macros/s/AKfycbyANVTtYWgdilqYE241CFlH69woGsaC-Whuq2lxepkp_mLKkuyjaEaKRO6i5B6ye_LHVA/exec",
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(orderData)
      }
    );

    const sheetJson = await sheetRes.json();

    document.getElementById("spinner").style.display = "none";

    if(sheetJson.status === "success"){
      localStorage.removeItem("zakuSelectedProduct");
      alert("‚úÖ Order submitted successfully!");
      window.location.href = "success.html";
    } else {
      alert("‚ùå Failed to save order");
    }

  } catch(err){
    document.getElementById("spinner").style.display = "none";
    console.error(err);
    alert("‚ùå Error submitting order");
  }
});
</script>

</body>
</html>
