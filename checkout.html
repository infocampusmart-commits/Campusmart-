<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Campusmart Checkout</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/x-icon" href="Blue 1.png">

<script src="https://js.paystack.co/v1/inline.js"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{font-family:Arial;background:#f5f5f5;padding:20px}
.box{max-width:500px;margin:auto;background:#fff;padding:20px;border-radius:12px}
.summary{display:flex;gap:10px;margin-bottom:10px}
.summary img{width:60px;height:60px;border-radius:8px;object-fit:cover}
button{background:#000;color:#fff;padding:12px;border:none;border-radius:8px;width:100%}
#loading{display:none;text-align:center;margin-top:10px}
</style>
</head>

<body>

<div class="box">
<h2>Checkout</h2>

<div id="summary"></div>

<input id="name" placeholder="Full Name" required>
<input id="email" placeholder="Email" required>
<input id="phone" placeholder="Phone" required>
<input id="location" placeholder="Location" required>
<input id="hall" placeholder="Hall" required>
<input id="room" placeholder="Room" required>

<button onclick="pay()">Pay with Paystack</button>
<div id="loading">Processing order...</div>
</div>

<script>
/* ðŸ”¥ FIREBASE CONFIG */
const firebaseConfig = {
    apiKey: "AIzaSyBoxC2fwlPKFMJsn2Pcg0BqxNVKwhbKBb4",
    authDomain: "campusmartcheckout.firebaseapp.com",
    projectId: "campusmartcheckout",
    storageBucket: "campusmartcheckout.firebasestorage.app",
    messagingSenderId: "94289670706",
    appId: "1:94289670706:web:67bc116dcbba9af41d422b"
  };

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* ðŸ”¥ VERY IMPORTANT */
auth.signInAnonymously();

/* CART */
const cart = JSON.parse(localStorage.getItem("campusmartCart")) || [];
let total = 0;

const summary = document.getElementById("summary");
cart.forEach(i=>{
  const t = i.price * i.quantity;
  total += t;
  summary.innerHTML += `
    <div class="summary">
      <img src="${i.img}">
      <div>
        <b>${i.name}</b><br>
        â‚¦${i.price} Ã— ${i.quantity}<br>
        <b>â‚¦${t}</b>
      </div>
    </div>`;
});
summary.innerHTML += `<hr><b>Total: â‚¦${total}</b>`;

/* PAYSTACK */
function pay(){
  PaystackPop.setup({
    key: "pk_live_b43df11e368a73ac564defaf565f7a626069d107",
    email: email.value,
    amount: total * 100,
    currency: "NGN",
    callback: submitOrder
  }).openIframe();
}

/* SAVE ORDER */
async function submitOrder(){
  document.getElementById("loading").style.display = "block";

  try{
    await db.collection("orders").add({
      customer:{
        name:name.value,
        email:email.value,
        phone:phone.value,
        location:location.value,
        hall:hall.value,
        room:room.value
      },
      items: cart.map(i=>({
        product:i.name,
        unitPrice:i.price,
        quantity:i.quantity,
        itemTotal:i.price*i.quantity
      })),
      orderTotal: total,
      date: firebase.firestore.FieldValue.serverTimestamp()
    });

    document.getElementById("loading").style.display = "none";
    localStorage.removeItem("campusmartCart");
    alert("Order successful!");
    location.href="success.html";

  }catch(err){
    document.getElementById("loading").style.display = "none";
    alert("Order failed: "+err.message);
    console.error(err);
  }
}
</script>
</body>
</html>
