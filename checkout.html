<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Checkout</title>
<link rel="icon" href="Blue 1.png">

<style>
body{
  font-family:Arial,sans-serif;
  background:#f5f5f5;
  padding:20px;
}
.checkout-container{
  max-width:500px;
  margin:auto;
  background:#fff;
  padding:20px;
  border-radius:12px;
  box-shadow:0 4px 10px rgba(0,0,0,.1);
}
h2{text-align:center;margin-bottom:20px}
.product-summary{text-align:center;margin-bottom:20px}
.product-summary img{
  width:120px;
  border-radius:8px;
  margin-bottom:10px;
}
label{font-weight:bold;margin-top:10px;display:block}
input,select,button{
  width:100%;
  padding:10px;
  margin-top:5px;
  margin-bottom:15px;
  border-radius:8px;
  border:1px solid #ddd;
}
button{
  background:blue;
  color:#fff;
  border:none;
  cursor:pointer;
}
button:hover{background:#87CEEB}
.pay-link{
  background:#0aa84f;
}
.pay-link:hover{
  background:#0ccf65;
}
#spinner{text-align:center;display:none;margin-top:10px}
</style>
</head>

<body>

<div class="checkout-container">
<h2>Checkout</h2>

<div id="checkoutProduct" class="product-summary"></div>

<form
  id="checkoutForm"
  action="https://script.google.com/macros/s/AKfycbxU3DlZE2qxMQaG5mnZtfutvXM9IW1uCBE_cI_lZbnkgxxZTBTgV1rEciTNQyMAmi9cUA/exec"
  method="POST"
>

<label>Full Name</label>
<input type="text" name="name" id="name" required>

<label>Email</label>
<input type="email" name="email" id="email" required>

<label>Location</label>
<select name="location" id="location" required>
<option value="">-- Select --</option>
<option value="Covenant University">Covenant University</option>
<option value="Bells University">Bells University</option>
<option value="Crawford University">Crawford University</option>
</select>

<label>Hall / Hostel</label>
<input type="text" name="hall" id="hall" required>

<label>Room Number</label>
<input type="text" name="room" id="room" required>

<label>Phone</label>
<input type="tel" name="phone" id="phone" required>

<!-- PAYMENT LINK -->
<label>Make Payment</label>
<a href="https://paystack.shop/pay/el2m0aq4uk" target="_blank">
  <button type="button" class="pay-link">üí≥ Pay Now</button>
</a>

<!-- RECEIPT -->
<label>Upload Payment Receipt</label>
<input type="file" id="receipt" accept="image/*,application/pdf" required>

<!-- HIDDEN FIELDS SENT TO APPS SCRIPT -->
<input type="hidden" name="productName" id="productName">
<input type="hidden" name="productPrice" id="productPrice">
<input type="hidden" name="receiptUrl" id="receiptUrl">

<button type="submit">üì¶ Submit Order</button>
</form>

<div id="spinner">Processing order...</div>
</div>

<script>
// =====================
// PRODUCT LOAD
// =====================
const product = JSON.parse(localStorage.getItem("zakuSelectedProduct"));

if(!product){
  alert("No product selected");
  window.location.href = "mart.html";
}

document.getElementById("checkoutProduct").innerHTML = `
  <img src="${product.img}">
  <h3>${product.name}</h3>
  <p><strong>‚Ç¶${product.price}</strong></p>
`;

document.getElementById("productName").value = product.name;
document.getElementById("productPrice").value = product.price;

// =====================
// CLOUDINARY CONFIG
// =====================
const CLOUD_NAME = "dgyrt3rpj";
const UPLOAD_PRESET = "campusmartstore";

// =====================
// FORM SUBMIT HANDLER
// =====================
document.getElementById("checkoutForm").addEventListener("submit", async function(e){
  e.preventDefault();

  const receiptFile = document.getElementById("receipt").files[0];
  if(!receiptFile){
    alert("Please upload payment receipt");
    return;
  }

  document.getElementById("spinner").style.display = "block";

  try {
    // Upload receipt to Cloudinary
    const cloudData = new FormData();
    cloudData.append("file", receiptFile);
    cloudData.append("upload_preset", UPLOAD_PRESET);

    const res = await fetch(
      `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/auto/upload`,
      { method: "POST", body: cloudData }
    );

    const data = await res.json();

    if(!data.secure_url){
      throw new Error("Receipt upload failed");
    }

    // Set receipt URL and submit form normally
    document.getElementById("receiptUrl").value = data.secure_url;

    this.submit(); // üöÄ NORMAL FORM POST (NO CORS)

  } catch (err) {
    document.getElementById("spinner").style.display = "none";
    alert("‚ùå Failed to upload receipt");
    console.error(err);
  }
});
</script>

</body>
</html>
