<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Checkout - CampusmartStore</title>
<link rel="icon" type="image/x-icon" href="Blue 1.png">
<style>
  body { font-family: Arial, sans-serif; background:#f2f2f2; margin:0; padding:0; }
  header { background:white; padding:15px; font-size:22px; text-align:center; font-weight:bold; }
  .checkout-container { width:90%; max-width:560px; background:white; margin:20px auto; padding:20px; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,0.06); }
  .btn { width:100%; background:#003cff; color:white; padding:12px; border:none; border-radius:6px; cursor:pointer; font-size:16px; font-weight:700; margin-top:10px; }
  .btn.secondary { background:#eee; color:#222; }
  .message { text-align:center; margin-top:12px; font-size:14px; color:black; min-height:20px; }
  .product-box { background:#f3f6ff; padding:12px; border-radius:8px; margin-bottom:16px; }
  input, textarea, select { width:100%; padding:10px; margin:6px 0 12px 0; border-radius:6px; border:1px solid #ddd; box-sizing:border-box; }
  #previewImg { width:100%; max-height:280px; margin-top:10px; display:none; border-radius:8px; border:1px solid #ddd; object-fit:contain; }
  label.small { font-size:13px; color:#333; display:block; margin-bottom:6px; }
</style>
</head>
<body>

<header>Checkout</header>

<div class="checkout-container">
  <h2>Order Summary</h2>
  <div class="product-box" id="productSummary">Loading...</div>

  <h2>Delivery Info</h2>
  <form id="orderForm" autocomplete="off">
    <input type="text" id="name" placeholder="Full Name" required>
    <input type="email" id="email" placeholder="Email" required>
    <input type="text" id="phone" placeholder="WhatsApp Number" required>

    <label class="small">Delivery (Hall / Room / Hostel)</label>
    <textarea id="delivery" placeholder="e.g. Hall 4, Room 101" required></textarea>

    <label class="small">Select Your University</label>
    <select id="university" required>
      <option value="">Select University</option>
      <option value="Covenant University">Covenant University</option>
      <option value="Bells University">Bells University</option>
      <option value="Crawford University">Crawford University</option>
    </select>

    <label class="small"><strong>Upload Payment Receipt (Screenshot)</strong></label>
    <input type="file" id="receipt" accept="image/*" required>
    <img id="previewImg" alt="Receipt preview">

    <button type="button" class="btn" id="payBtn">üí≥ Pay With Paystack</button>
    <button class="btn secondary" type="submit">Submit Order</button>
  </form>

  <div class="message" id="message"></div>
</div>

<script src="https://js.paystack.co/v1/inline.js"></script>
<script>
/* ============ CONFIG - REPLACE THESE ============ */
const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzEMwalUx5t2PBylVzziIFW72skdUJH-5w4YeiXUYY8fF-tKR_2yF2ZjJKcL_JJM0Lg/exec";            // example: https://script.google.com/macros/s/XXX/exec
const PAYSTACK_PUBLIC_KEY = "pk_live_b43df11e368a73ac564defaf565f7a626069d107";   // example: pk_live_xxx
const CLOUDINARY_CLOUD_NAME = "dgyrt3rpj";
const CLOUDINARY_UPLOAD_PRESET = "campusmart_uploads";
/* ================================================ */

/* DOM */
const productBox = document.getElementById("productSummary");
const form = document.getElementById("orderForm");
const receiptInput = document.getElementById("receipt");
const previewImg = document.getElementById("previewImg");
const message = document.getElementById("message");
const payBtn = document.getElementById("payBtn");

/* Load cart from localStorage */
let cart = JSON.parse(localStorage.getItem("campusmartCart") || "[]");

function renderCart() {
  if (!cart || cart.length === 0) {
    productBox.innerHTML = "<p>No product selected. Please add items to your cart.</p>";
    return;
  }
  let total = 0;
  const html = cart.map(item => {
    const itemTotal = (Number(item.price) || 0) * (Number(item.quantity) || 0);
    total += itemTotal;
    return `<div><strong>${escapeHtml(item.name)}</strong> √ó ${escapeHtml(String(item.quantity))} ‚Äî ‚Ç¶${formatNumber(itemTotal)}</div>`;
  }).join("");
  productBox.innerHTML = html + `<hr><p><strong>Total: ‚Ç¶${formatNumber(total)}</strong></p>`;
}

/* Small helpers */
function formatNumber(n){ return new Intl.NumberFormat().format(n); }
function escapeHtml(s){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

renderCart();

/* Preview receipt */
receiptInput.addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (!file) { previewImg.style.display = 'none'; return; }
  previewImg.src = URL.createObjectURL(file);
  previewImg.style.display = 'block';
});

/* Upload to Cloudinary (unsigned preset) */
async function uploadToCloudinary(file){
  if (!file) return "";
  const url = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/upload`;
  const fd = new FormData();
  fd.append("file", file);
  fd.append("upload_preset", CLOUDINARY_UPLOAD_PRESET);

  const resp = await fetch(url, { method: "POST", body: fd });
  if(!resp.ok) throw new Error("Cloudinary upload failed: " + resp.statusText);
  const j = await resp.json();
  return j.secure_url || "";
}

/* Paystack payment */
payBtn.addEventListener('click', () => {
  const email = document.getElementById("email").value.trim();
  if(!email) return alert("Please enter your email before paying.");

  const total = cart.reduce((s,i)=> s + (Number(i.price)||0) * (Number(i.quantity)||0), 0);
  if (total <= 0) return alert("Cart is empty or invalid total.");

  const amountKobo = Math.round(total * 100);

  const handler = PaystackPop.setup({
    key: PAYSTACK_PUBLIC_KEY,
    email: email,
    amount: amountKobo,
    currency: "NGN",
    ref: "CAMPUSMART_" + Date.now(),
    callback: function(response){
      // Save reference for submit
      sessionStorage.setItem("campusmart_pay_ref", response.reference);
      alert("Payment successful! Reference saved.");
    },
    onClose: function(){ alert("Payment cancelled"); }
  });

  handler.openIframe();
});

/* Submit order: upload receipt -> send to Apps Script */
form.addEventListener('submit', async (e) => {
  e.preventDefault();
  try {
    message.style.color = "black";
    message.textContent = "Validating...";

    // Ensure payment done
    const payRef = sessionStorage.getItem("campusmart_pay_ref");
    if(!payRef) throw new Error("Please complete the Paystack payment first (click Pay button and finish).");

    // Basic form validation
    const name = document.getElementById("name").value.trim();
    const email = document.getElementById("email").value.trim();
    const phone = document.getElementById("phone").value.trim();
    const delivery = document.getElementById("delivery").value.trim();
    const university = document.getElementById("university").value.trim();

    if(!name || !email || !phone || !delivery || !university) throw new Error("Please fill all required fields.");

    message.textContent = "‚è≥ Uploading receipt...";
    const file = receiptInput.files[0];
    const imageUrl = await uploadToCloudinary(file);

    // Prepare order payload
    const amount = cart.reduce((s,i)=> s + (Number(i.price)||0) * (Number(i.quantity)||0), 0);
    const orderData = {
      name, email, phone, delivery, university,
      items: cart,
      amount,
      payment_reference: payRef,
      image_url: imageUrl
    };

    message.textContent = "‚è≥ Sending order to server...";
    const resp = await fetch(APPS_SCRIPT_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(orderData)
    });

    // handle network / non-json
    if (!resp.ok) {
      const txt = await resp.text().catch(()=>null);
      throw new Error("Server error: " + (txt || resp.statusText));
    }

    const json = await resp.json().catch(()=>{ throw new Error("Invalid JSON response from server") });

    if (json.status !== "success") throw new Error(json.message || "Server returned an error");

    message.style.color = "green";
    message.textContent = "‚úÖ Order submitted ‚Äî thank you!";
    // cleanup
    localStorage.removeItem("campusmartCart");
    sessionStorage.removeItem("campusmart_pay_ref");
    // Redirect after short delay
    setTimeout(()=> window.location.href = "mart.html", 1800);

  } catch (err) {
    message.style.color = "red";
    message.textContent = "‚ùå " + (err.message || err);
    console.error(err);
  }
});
</script>
</body>
</html>
