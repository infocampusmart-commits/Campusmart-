<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Checkout - CampusmartStore</title>
<link rel="icon" type="image/x-icon" href="Blue 1.png">
<style>
body { font-family: Arial, sans-serif; background:#f2f2f2; margin:0; padding:0; }
header { background:white; padding:15px; font-size:22px; text-align:center; font-weight:bold; }
.checkout-container { width:90%; max-width:500px; background:white; margin:20px auto; padding:20px; border-radius:10px; }
.btn { width:100%; background:#003cff; color:white; padding:12px; border:none; border-radius:5px; cursor:pointer; font-size:16px; font-weight:bold; margin-top:10px; }
.btn:hover { background:#4D8BFF; }
.message { text-align:center; margin-top:10px; font-size:14px; color:black; }
.product-box { background:#e9e9ff; padding:10px; border-radius:8px; margin-bottom:15px; }
input, textarea, select { width:100%; padding:10px; margin:5px 0 10px 0; border-radius:5px; border:1px solid #ccc; box-sizing:border-box; }
#previewImg { width: 100%; max-height: 250px; margin-top: 10px; display: none; border-radius: 8px; border: 1px solid #ddd; }
</style>
</head>
<body>

<header>Checkout</header>

<div class="checkout-container">
  <h2>Order Summary</h2>
  <div class="product-box" id="productSummary">Loading...</div>

  <h2>Delivery Info</h2>
  <form id="orderForm">
    <input type="text" id="name" placeholder="Full Name" required>
    <input type="email" id="email" placeholder="Email" required>
    <input type="text" id="phone" placeholder="WhatsApp Number" required>

    <textarea id="delivery" placeholder="Hall / Room / Hostel Delivery Info" required></textarea>

    <label><strong>Select Your University</strong></label>
    <select id="university" required>
      <option value="">Select University</option>
      <option value="Covenant University">Covenant University</option>
      <option value="Bells University">Bells University</option>
      <option value="Crawford University">Crawford University</option>
    </select>

    <label><strong>Upload Payment Receipt (Screenshot)</strong></label>
    <input type="file" id="receipt" accept="image/*" required>
    <img id="previewImg" alt="receipt preview">

    <button type="button" class="btn" id="payBtn">üí≥ Pay With Paystack</button>
    <button class="btn" type="submit">Submit Order</button>
  </form>

  <div class="message" id="message"></div>
</div>

<!-- Paystack inline -->
<script src="https://js.paystack.co/v1/inline.js"></script>
<script src="https://js.paystack.co/v1/inline.js"></script>
<script>
const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzEMwalUx5t2PBylVzziIFW72skdUJH-5w4YeiXUYY8fF-tKR_2yF2ZjJKcL_JJM0Lg/exec";
const CLOUDINARY_CLOUD_NAME = "dgyrt3rpj";
const CLOUDINARY_UPLOAD_PRESET = "campusmart_uploads";

const form = document.getElementById("orderForm");
const receiptInput = document.getElementById("receipt");

async function uploadReceipt(file) {
  if (!file) return "";
  const formData = new FormData();
  formData.append("file", file);
  formData.append("upload_preset", CLOUDINARY_UPLOAD_PRESET);
  const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/upload`, {
    method: "POST",
    body: formData
  });
  const data = await res.json();
  return data.secure_url;
}

document.getElementById("payBtn").addEventListener("click", function() {
  const email = document.getElementById("email").value.trim();
  if (!email) return alert("Enter email first!");
  const cart = JSON.parse(localStorage.getItem("campusmartCart") || "[]");
  const totalAmount = cart.reduce((s, i) => s + i.price * i.quantity, 0) * 100;

  let handler = PaystackPop.setup({
    key: "YOUR_PAYSTACK_PUBLIC_KEY",
    email: email,
    amount: totalAmount,
    currency: "NGN",
    ref: "CAMPUSMART_" + Date.now(),
    callback: function(response) {
      sessionStorage.setItem("campusmart_pay_ref", response.reference);
      alert("Payment successful!");
    },
    onClose: function() { alert("Payment cancelled"); }
  });
  handler.openIframe();
});

form.addEventListener("submit", async (e) => {
  e.preventDefault();

  const payRef = sessionStorage.getItem("campusmart_pay_ref");
  if (!payRef) return alert("Please complete payment first.");

  const file = receiptInput.files[0];
  const imageUrl = await uploadReceipt(file);

  const cart = JSON.parse(localStorage.getItem("campusmartCart") || "[]");

  const orderData = {
    name: document.getElementById("name").value,
    email: document.getElementById("email").value,
    phone: document.getElementById("phone").value,
    delivery: document.getElementById("delivery").value,
    university: document.getElementById("university").value,
    items: cart.map(i => ({ name: i.name, quantity: i.quantity, price: i.price })),
    amount: cart.reduce((s, i) => s + i.price * i.quantity, 0),
    payment_reference: payRef,
    image_url: imageUrl
  };

  try {
    const res = await fetch(APPS_SCRIPT_URL, {
      method: "POST",
      body: JSON.stringify(orderData)
    });
    const result = await res.json();
    if (result.status !== "success") throw new Error(result.message || "Server error");
    alert("‚úÖ Order submitted successfully!");
    localStorage.removeItem("campusmartCart");
    sessionStorage.removeItem("campusmart_pay_ref");
    location.href = "mart.html";
  } catch (err) {
    alert("‚ùå " + err.message);
    console.error(err);
  }
});
</script>

</body>
</html>
