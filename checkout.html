<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Checkout - CampusMart</title>
<style>
body { font-family: Arial, sans-serif; background:#f2f2f2; margin:0; padding:0; }
header { background:white; padding:15px; font-size:22px; text-align:center; font-weight:bold; }
.checkout-container { width:90%; max-width:500px; background:white; margin:20px auto; padding:20px; border-radius:10px; }
.btn { width:100%; background:blue; color:white; padding:12px; border:none; border-radius:5px; cursor:pointer; font-size:16px; font-weight:bold; }
.btn:hover { background:#4D8BFF; }
.message { text-align:center; margin-top:10px; font-size:14px; }
.product-box { background:#e9e9ff; padding:10px; border-radius:8px; margin-bottom:15px; }
</style>
</head>
<body>

<header>Checkout</header>
<div class="checkout-container">

<h2>Order Summary</h2>
<div class="product-box" id="productSummary">Loading...</div>

<h2>Delivery Info</h2>
<form id="checkoutForm">
<label>Hall & Room No.</label>
<input type="text" id="hallRoom" required placeholder="Example: Daniel Hall Room 04" />

<label>Alternative Hall/Room</label>
<input type="text" id="altHall" placeholder="Optional" />

<label>Additional Info</label>
<textarea id="deliveryInfo" rows="3" placeholder="E.g: Call me when outside..."></textarea>

<button class="btn" type="submit">Proceed to Payment</button>
</form>

<div class="message" id="message"></div>
</div>

<script>
const productBox = document.getElementById("productSummary");
const form = document.getElementById("checkoutForm");
const message = document.getElementById("message");

// Load cart
const cart = JSON.parse(localStorage.getItem("campusmartCart")) || [];

// Check token
const token = localStorage.getItem("token");
if (!token) {
  localStorage.setItem("redirectAfterLogin", "checkout.html");
  window.location.href = "signin.html";
}

// Show selected product
if (cart.length === 0) {
  productBox.innerHTML = "<p>No product selected.</p>";
} else {
  const item = cart[0];
  const total = item.price * item.quantity;

  productBox.innerHTML = `
    <p><strong>Product:</strong> ${item.name}</p>
    <p><strong>Price:</strong> ‚Ç¶${item.price} x ${item.quantity}</p>
    <p><strong>Total:</strong> ‚Ç¶${total}</p>
  `;
}

form.addEventListener("submit", async (e) => {
  e.preventDefault();
  if (cart.length === 0) {
    message.textContent = "‚ùå No product in cart.";
    return;
  }

  const item = cart[0];
  const totalAmount = item.price * item.quantity;

  // Payload matches Postman working request
  const orderData = {
    totalAmount: Number(totalAmount),
    hall_room_no: document.getElementById("hallRoom").value,
    alt_hall_room: document.getElementById("altHall").value,
    delivery_info: document.getElementById("deliveryInfo").value,
    items: [
      {
        item_id: Number(item.id),
        name: item.name,
        price: Number(item.price),
        quantity: Number(item.quantity),
        total: Number(totalAmount)
      }
    ]
  };

  console.log("üì¶ Sending request:", JSON.stringify(orderData, null, 2));

  message.style.color = "black";
  message.textContent = "‚è≥ Processing order...";

  try {
    const response = await fetch("https://campusmart-proxy.vercel.app/api/checkout", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}`
      },
      body: JSON.stringify(orderData)
    });

    const data = await response.json();

    if (!response.ok) {
      message.style.color = "red";
      message.textContent = data.message || "‚ùå Payment failed.";
      return;
    }

    if (data?.data?.PAYSTACK_URL) {
      window.location.href = data.data.PAYSTACK_URL;
    } else {
      message.style.color = "red";
      message.textContent = "‚ùå No Paystack URL received.";
    }

  } catch (err) {
    message.style.color = "red";
    message.textContent = "üö´ Network error: " + err.message;
  }
});
</script>

</body>
</html>
