<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Checkout - CampusmartStore</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f5f7fb;margin:0;padding:0}
    header{background:#fff;padding:16px;text-align:center;font-weight:700;box-shadow:0 1px 4px rgba(0,0,0,0.06)}
    .container{max-width:680px;margin:24px auto;padding:20px;background:#fff;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
    .section{margin-bottom:18px}
    .product-box{background:#f1f5ff;padding:12px;border-radius:8px}
    .item{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px dashed #e6ecff}
    .item:last-child{border-bottom:none}
    .total{font-size:18px;font-weight:700;margin-top:12px;text-align:right}
    input,textarea,select{width:100%;padding:10px;border-radius:6px;border:1px solid #ddd;margin-top:8px;box-sizing:border-box}
    .row{display:flex;gap:12px}
    .col{flex:1}
    .btn{display:inline-block;width:100%;padding:12px;background:#003cff;color:#fff;border:none;border-radius:8px;font-weight:700;cursor:pointer;margin-top:10px}
    .btn.secondary{background:#eee;color:#111}
    .message{min-height:26px;margin-top:10px;text-align:center}
    #previewImg{display:none;width:100%;max-height:280px;object-fit:contain;margin-top:10px;border-radius:8px}
    small.hint{color:#666}
  </style>
</head>
<body>
  <header>CampusmartStore ‚Äî Checkout</header>

  <div class="container">
    <div class="section">
      <h3>Order Summary</h3>
      <div class="product-box" id="productSummary">Loading...</div>
      <div class="total">Total: <span id="totalDisplay">‚Ç¶0</span></div>
    </div>

    <div class="section">
      <h3>Delivery Info</h3>
      <form id="orderForm" autocomplete="off">
        <input id="name" type="text" placeholder="Full name" required />
        <input id="email" type="email" placeholder="Email" required />
        <input id="phone" type="text" placeholder="WhatsApp number" required />
        <textarea id="delivery" rows="2" placeholder="Hall / Room / Hostel delivery info" required></textarea>

        <label class="hint">Select your university</label>
        <select id="university" required>
          <option value="">Select university</option>
          <option>Covenant University</option>
          <option>Bells University</option>
          <option>Crawford University</option>
        </select>

        <label class="hint" style="margin-top:10px"><strong>Upload payment receipt (screenshot)</strong></label>
        <input id="receipt" type="file" accept="image/*" required />
        <img id="previewImg" alt="receipt preview" />

        <button type="button" id="payBtn" class="btn">üí≥ Pay with Paystack</button>
        <button type="submit" id="submitBtn" class="btn secondary">Submit Order</button>
      </form>

      <div class="message" id="message"></div>
    </div>
  </div>

  <!-- Paystack inline -->
  <script src="https://js.paystack.co/v1/inline.js"></script>
  <script>
  /***** CONFIG - REPLACE THESE BEFORE USAGE *****/
  const PAYSTACK_PUBLIC_KEY = "pk_live_b43df11e368a73ac564defaf565f7a626069d107";   // e.g. pk_live_xxx
  const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxKJklpE_Zh-NdrGcZMT42KXk3m27ELNMakhcMcrMv8Ty7ituyphJEAc5QeFyBhNGMB/exec";          // e.g. https://script.google.com/macros/s/XXXXX/exec
  const CLOUDINARY_CLOUD_NAME = "dgyrt3rpj";
  const CLOUDINARY_UPLOAD_PRESET = "campusmart_uploads";
  /***********************************************/

  // Elements
  const productSummary = document.getElementById('productSummary');
  const totalDisplay = document.getElementById('totalDisplay');
  const orderForm = document.getElementById('orderForm');
  const payBtn = document.getElementById('payBtn');
  const submitBtn = document.getElementById('submitBtn');
  const receiptInput = document.getElementById('receipt');
  const previewImg = document.getElementById('previewImg');
  const messageEl = document.getElementById('message');

  // Load cart from localStorage (key: campusmartCart)
  const cart = JSON.parse(localStorage.getItem('campusmartCart') || '[]');
  console.log("Loaded cart:", cart);

  function renderCart() {
    if (!cart || cart.length === 0) {
      productSummary.innerHTML = '<p style="color:#c00;font-weight:600">Your cart is empty.</p>';
      totalDisplay.textContent = '‚Ç¶0';
      return;
    }
    let total = 0;
    productSummary.innerHTML = cart.map(item => {
      const lineTotal = Number(item.price || 0) * Number(item.quantity || 1);
      total += lineTotal;
      return `<div class="item"><div>${escapeHtml(item.name)} <small>√ó ${escapeHtml(String(item.quantity))}</small></div><div>‚Ç¶${formatNumber(lineTotal)}</div></div>`;
    }).join('');
    totalDisplay.textContent = '‚Ç¶' + formatNumber(total);
    // store total for later use
    productSummary.dataset.total = total;
  }

  function formatNumber(n){ return new Intl.NumberFormat().format(n); }
  function escapeHtml(s){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

  renderCart();

  // Preview receipt image
  receiptInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) { previewImg.style.display = 'none'; return; }
    previewImg.src = URL.createObjectURL(file);
    previewImg.style.display = 'block';
  });

  // Upload image to Cloudinary (unsigned)
  async function uploadToCloudinary(file){
    if (!file) return "";
    const url = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/upload`;
    const fd = new FormData();
    fd.append('file', file);
    fd.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);

    const res = await fetch(url, { method: 'POST', body: fd });
    if (!res.ok) throw new Error('Cloudinary upload failed: ' + res.statusText);
    const j = await res.json();
    return j.secure_url || '';
  }

  // Paystack - open popup and save reference to sessionStorage
  payBtn.addEventListener('click', () => {
    // basic validation
    const email = document.getElementById('email').value.trim();
    if (!email) return alert('Please enter an email before paying.');
    if (!cart || cart.length === 0) return alert('Cart is empty.');

    // compute total in kobo
    const total = Number(productSummary.dataset.total || 0);
    if (!total || total <= 0) return alert('Invalid cart total.');
    const amountKobo = Math.round(total * 100);

    const handler = PaystackPop.setup({
      key: PAYSTACK_PUBLIC_KEY,
      email: email,
      amount: amountKobo,
      currency: 'NGN',
      ref: 'CAMPUSMART_' + Date.now(),
      callback: function(response){
        // save reference
        sessionStorage.setItem('campusmart_pay_ref', response.reference);
        messageEl.style.color = 'green';
        messageEl.textContent = 'Payment successful ‚Äî reference saved.';
      },
      onClose: function(){ alert('Payment popup closed.'); }
    });

    handler.openIframe();
  });

  // Submit order
  orderForm.addEventListener('submit', async (ev) => {
    ev.preventDefault();
    try {
      messageEl.style.color = 'black';
      messageEl.textContent = 'Validating order...';

      // Ensure payment completed
      const payRef = sessionStorage.getItem('campusmart_pay_ref');
      if (!payRef) throw new Error('Please complete the Paystack payment first (click Pay and finish).');

      // Gather fields
      const name = document.getElementById('name').value.trim();
      const email = document.getElementById('email').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const delivery = document.getElementById('delivery').value.trim();
      const university = document.getElementById('university').value.trim();

      if (!name || !email || !phone || !delivery || !university) throw new Error('Please fill all required fields.');

      messageEl.textContent = 'Uploading receipt...';
      const receiptFile = receiptInput.files[0];
      const receiptUrl = await uploadToCloudinary(receiptFile);

      // Build payload
      const payload = {
        name, email, phone, delivery, university,
        items: cart.map(i => ({ name: i.name, quantity: i.quantity, price: i.price })),
        amount: Number(productSummary.dataset.total || 0),
        payment_reference: payRef,
        image_url: receiptUrl
      };

      messageEl.textContent = 'Sending order to server...';

      // POST to Apps Script (expects JSON)
      const resp = await fetch(APPS_SCRIPT_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      // network error handling
      if (!resp.ok) {
        const txt = await resp.text().catch(()=>null);
        throw new Error('Server error: ' + (txt || resp.statusText));
      }

      const json = await resp.json().catch(()=>{ throw new Error('Invalid server response'); });
      if (json.status !== 'success') throw new Error(json.message || 'Server returned error');

      messageEl.style.color = 'green';
      messageEl.textContent = 'Order submitted successfully ‚Äî thank you!';
      // cleanup
      localStorage.removeItem('campusmartCart');
      sessionStorage.removeItem('campusmart_pay_ref');
      // redirect after short delay
      setTimeout(()=> window.location.href = 'mart.html', 1600);

    } catch (err) {
      messageEl.style.color = 'red';
      messageEl.textContent = '‚ùå ' + (err.message || err);
      console.error(err);
    }
  });

  </script>
</body>
</html>
