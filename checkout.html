<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Checkout - CampusmartStore</title>

  <style>
    body { font-family: Arial; background:#f2f2f2; margin:0; padding:0; }
    header { background:white; padding:15px; font-size:22px; text-align:center; font-weight:bold; }
    .checkout-container { max-width:500px; margin:20px auto; background:white; padding:20px; border-radius:10px; }
    .btn { width:100%; background:#003cff; color:white; padding:12px; border:none; border-radius:5px; font-weight:bold; cursor:pointer; margin-top:10px; }
    input, textarea, select { width:100%; padding:10px; margin-top:8px; border:1px solid #ccc; border-radius:5px; }
    #previewImg { width:100%; max-height:250px; display:none; margin-top:10px; border-radius:8px; }
  </style>
</head>

<body>

<header>Checkout</header>

<div class="checkout-container">

  <h3>Delivery Information</h3>
  <form id="orderForm">

    <input type="text" id="name" placeholder="Full Name" required>
    <input type="email" id="email" placeholder="Email" required>
    <input type="text" id="phone" placeholder="WhatsApp Number" required>

    <textarea id="delivery" placeholder="Hall / Room / Hostel" required></textarea>

    <select id="university" required>
      <option value="">Select University</option>
      <option value="Covenant University">Covenant University</option>
      <option value="Bells University">Bells University</option>
      <option value="Crawford University">Crawford University</option>
    </select>

    <label><strong>Upload Payment Receipt</strong></label>
    <input type="file" id="receipt" accept="image/*" required>
    <img id="previewImg">

    <button type="button" class="btn" id="payBtn">Pay with Paystack</button>
    <button type="submit" class="btn">Submit Order</button>
  </form>

</div>

<script src="https://js.paystack.co/v1/inline.js"></script>
<script>
const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzEMwalUx5t2PBylVzziIFW72skdUJH-5w4YeiXUYY8fF-tKR_2yF2ZjJKcL_JJM0Lg/exec";
const PAYSTACK_PUBLIC_KEY = "pk_live_b43df11e368a73ac564defaf565f7a626069d107";

const CLOUDINARY_URL = "https://api.cloudinary.com/v1_1/dgyrt3rpj/upload";
const CLOUDINARY_PRESET = "campusmart_uploads";

document.getElementById("receipt").addEventListener("change", e => {
  let file = e.target.files[0];
  let img = document.getElementById("previewImg");
  img.src = URL.createObjectURL(file);
  img.style.display = "block";
});

// Upload to Cloudinary
async function uploadReceipt(file) {
  let data = new FormData();
  data.append("file", file);
  data.append("upload_preset", CLOUDINARY_PRESET);

  const res = await fetch(CLOUDINARY_URL, { method: "POST", body: data });
  const json = await res.json();

  return json.secure_url;
}

// Paystack button
document.getElementById("payBtn").onclick = function () {
  const email = document.getElementById("email").value;
  if (!email) return alert("Enter email first!");

  const cart = JSON.parse(localStorage.getItem("campusmartCart") || "[]");
  const amount = cart.reduce((s, i) => s + i.price * i.quantity, 0) * 100;

  let handler = PaystackPop.setup({
    key: PAYSTACK_PUBLIC_KEY,
    email: email,
    amount,
    currency: "NGN",
    ref: "CAMPUSMART_" + Date.now(),
    callback: res => {
      sessionStorage.setItem("pay_ref", res.reference);
      alert("Payment successful!");
    }
  });

  handler.openIframe();
};

// Submit Order
document.getElementById("orderForm").onsubmit = async (e) => {
  e.preventDefault();

  const payRef = sessionStorage.getItem("pay_ref");
  if (!payRef) return alert("Please complete payment first.");

  const cart = JSON.parse(localStorage.getItem("campusmartCart") || "[]");
  const file = document.getElementById("receipt").files[0];
  const receiptUrl = await uploadReceipt(file);

  let data = {
    name: name.value,
    email: email.value,
    phone: phone.value,
    delivery: delivery.value,
    university: university.value,
    items: cart,
    amount: cart.reduce((s, i) => s + i.price * i.quantity, 0),
    payment_reference: payRef,
    image_url: receiptUrl
  };

  const res = await fetch(APPS_SCRIPT_URL, {
    method: "POST",
    body: JSON.stringify(data)
  });

  const json = await res.json();
  if (json.status === "success") {
    alert("Order Submitted!");
    localStorage.removeItem("campusmartCart");
    sessionStorage.removeItem("pay_ref");
  } else {
    alert("Error: " + json.message);
  }
};
</script>

</body>
</html>
