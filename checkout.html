<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" type="image/x-icon" href="Blue 1.png">
<title>Checkout - CampusmartStore</title>

<style>
body { font-family: Arial, sans-serif; background:#f2f2f2; margin:0; padding:0; }
header { background:white; padding:15px; font-size:22px; text-align:center; font-weight:bold; }
.checkout-container { width:90%; max-width:500px; background:white; margin:20px auto; padding:20px; border-radius:10px; }
.btn { width:100%; background:#003cff; color:white; padding:12px; border:none; border-radius:5px; cursor:pointer; font-size:16px; font-weight:bold; margin-top:10px; }
.btn:hover { background:#4D8BFF; }
.message { text-align:center; margin-top:10px; font-size:14px; color:black; }

.product-box { background:#e9e9ff; padding:10px; border-radius:8px; margin-bottom:15px; }
input, textarea, select { width:100%; padding:10px; margin:5px 0 10px 0; border-radius:5px; border:1px solid #ccc; box-sizing:border-box; }

#previewImg {
  width: 100%;
  max-height: 250px;
  margin-top: 10px;
  display: none;
  border-radius: 8px;
  border: 1px solid #ddd;
}
</style>
</head>
<body>

<header>Checkout</header>

<div class="checkout-container">

<h2>Order Summary</h2>
<div class="product-box" id="productSummary">Loading...</div>

<h2>Delivery Info</h2>

<form id="orderForm">

  <input type="text" id="name" placeholder="Full Name" required>
  <input type="email" id="email" placeholder="Email" required>
  <input type="text" id="phone" placeholder="WhatsApp Number" required>

  <textarea id="delivery" placeholder="Hall / Room / Hostel Delivery Info" required></textarea>

  <label><strong>Select Your University</strong></label>
  <select id="university" required>
    <option value="">Select University</option>
    <option value="Covenant University">Covenant University</option>
    <option value="Bells University">Bells University</option>
    <option value="Crawford University">Crawford University</option>
  </select>

  <label><strong>Upload Payment Receipt (Screenshot)</strong></label>
  <input type="file" id="receipt" accept="image/*" required>

  <!-- Image Preview -->
  <img id="previewImg">

  <button type="button" class="btn" id="payBtn">üí≥ Pay With Paystack</button>
  <button class="btn" type="submit">Submit Order</button>

</form>

<div class="message" id="message"></div>
</div>

<script src="https://js.paystack.co/v1/inline.js"></script>

<script>
const productBox = document.getElementById("productSummary");
const form = document.getElementById("orderForm");
const message = document.getElementById("message");
const previewImg = document.getElementById("previewImg");

// Load cart
const cart = JSON.parse(localStorage.getItem("campusmartCart")) || [];

// Display cart items
if (cart.length === 0) {
  productBox.innerHTML = "<p>No product selected.</p>";
} else {
  let total = 0;
  productBox.innerHTML = cart.map(item => {
    const itemTotal = item.price * item.quantity;
    total += itemTotal;
    return `<p>${item.name} x ${item.quantity} = ‚Ç¶${itemTotal}</p>`;
  }).join("") + `<hr><p><strong>Total: ‚Ç¶${total}</strong></p>`;
}

// üñº Show Receipt Image Preview
document.getElementById("receipt").addEventListener("change", function () {
  const file = this.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = () => {
    previewImg.src = reader.result;
    previewImg.style.display = "block";
  };
  reader.readAsDataURL(file);
});

// üí≥ PAYSTACK PAYMENT BUTTON
document.getElementById("payBtn").addEventListener("click", function () {

  const name = document.getElementById("name").value;
  const email = document.getElementById("email").value;

  if (!name || !email) {
    alert("Please enter your Name and Email before paying.");
    return;
  }

  const totalAmount = cart.reduce((sum, i) => sum + i.price * i.quantity, 0) * 100;

  let handler = PaystackPop.setup({
    key: "pk_live_b43df11e368a73ac564defaf565f7a626069d107",
    email: email,
    amount: totalAmount,
    currency: "NGN",
    ref: "CAMPUSMART_" + Date.now(),

    callback: function(response){
      alert("Payment Successful ‚úî");
      sessionStorage.setItem("campusmart_pay_ref", response.reference);
    },

    onClose: function(){
      alert("Payment Cancelled ‚ùå");
    }
  });

  handler.openIframe();
});

// üì§ SUBMIT ORDER TO GOOGLE APPS SCRIPT
form.addEventListener("submit", async (e) => {
  e.preventDefault();

  if (cart.length === 0) {
    message.style.color = "red";
    message.textContent = "‚ùå No items in cart.";
    return;
  }

  const payRef = sessionStorage.getItem("campusmart_pay_ref");
  if (!payRef) {
    message.style.color = "red";
    message.textContent = "‚ö† Please make payment before submitting your order.";
    return;
  }

  const receiptFile = document.getElementById("receipt").files[0];
  const reader = new FileReader();

  reader.onload = async () => {
    const orderData = {
      name: document.getElementById("name").value,
      email: document.getElementById("email").value,
      phone: document.getElementById("phone").value,
      university: document.getElementById("university").value,
      delivery: document.getElementById("delivery").value,
      items: cart.map(i => `${i.name} x ${i.quantity}`).join(", "),
      amount: cart.reduce((s, i) => s + i.price * i.quantity, 0),
      receipt: reader.result,
      payment_reference: payRef
    };

    message.textContent = "‚è≥ Sending order... please wait...";

    const response = await fetch(
      "https://script.google.com/macros/s/AKfycbzEMwalUx5t2PBylVzziIFW72skdUJH-5w4YeiXUYY8fF-tKR_2yF2ZjJKcL_JJM0Lg/exec",    // <-- Replace with your Apps Script URL
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(orderData)
      }
    );

    const result = await response.json();

    if (result.status === "success") {
      message.style.color = "green";
      message.textContent = "‚úÖ Order submitted successfully!";

      // Clear data
      localStorage.removeItem("campusmartCart");
      sessionStorage.removeItem("campusmart_pay_ref");

      setTimeout(() => location.href = "mart.html", 3000);
    } else {
      message.style.color = "red";
      message.textContent = "‚ùå Error: " + result.message;
    }
  };

  reader.readAsDataURL(receiptFile);
});
</script>

</body>
</html>
